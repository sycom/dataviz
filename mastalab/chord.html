<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Traitement de données de mastodon.etalab.gouv.fr</title>
    <meta charset="utf-8">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans" rel="stylesheet" />
    <link rel="stylesheet" href="../lib/normalize-min.css" media="all" type="text/css" />
    <link rel="stylesheet" href="../lib/font-awesome-min.css" media="all" type="text/css" />
    <link rel="stylesheet" href="../css/styles.css" media="all" type="text/css" />
    <script src="../lib/d3.v3.min.js"></script>
    <style>
        .chord {
            fill-opacity: .67;
        }
    </style>
</head>

<body>
    <div id="container">
        <div class="flotteur">
            <nav id="navigation" role="navigation" class="nav">
                <a class="fa fa-code-fork button" href="https://framagit.org/sycom/dataviz" title="code source"></a>
                <a class="fa fa-home button" href="../" title="code source"></a>
            </nav>
        </div>
        <h1>Qui sont etalab.gouv.fr?</h1>
        <p>quelques essais de traitement des <a href="https://gist.github.com/cquest/bbf1f88f305564fe80a47d7951255eb1#file-domaines-csv" target="_blank">données d'inscription</a> sur l'instance mastodon <i>https://mastodon.etalab.gouv.fr</i>. Ici un diagramme
            d'accord (qui reste perfectible). Voir aussi les autres versions : <a href="index.html" target="_blank">diagramme hiérarchique circulaire</a>, <a href="bubble.html" target="_blank">diagramme en bulles</a>.</p>
        <p id="resultat"></p>

        <div id="graphe">
            <script>
var outerRadius = 960 / 2,
    innerRadius = outerRadius - 130;

var fill = d3.scale.category20c();

var chord = d3.layout.chord()
    .padding(.04)
    .sortSubgroups(d3.descending)
    .sortChords(d3.descending);

var arc = d3.svg.arc()
    .innerRadius(innerRadius)
    .outerRadius(innerRadius + 20);

var svg = d3.select("#graphe").append("svg")
    .attr("width", outerRadius * 2)
    .attr("height", outerRadius * 2)
    .append("g")
    .attr("transform", "translate(" + outerRadius + "," + outerRadius + ")");

/* traitement des données directement issues de etalab.gouv.fr */
d3.csv("https://gist.githubusercontent.com/cquest/bbf1f88f305564fe80a47d7951255eb1/raw/e5832d9ede04ea278cfe100cb88e39bf663738b5/domaines.csv", function(error, data) {
    if (error) {
        throw error;
        console.log("maybe offline ? trying local cached data");
        d3.csv("./data/mastodon.etalab.csv", function(er, da) {
            if (er) throw er;
            createChord(da);
        });
    }
    else createChord(data);
});
d3.select(self.frameElement).style("height", outerRadius * 2 + "px");

function createChord(data) {
    var Read = [];
    for (var d in data) {
        // correction du domaine pour les ac-xxxx
        var dom = data[d].domaine.replace(/(ac)-([-\w]*)\.fr/g, "$2.$1.fr");
        // explosion du domaine
        var Id = dom.split(".");
        // ajout des informations de décompte et hierarchiques
        for (var s = 0; s < Id.length - 1; s++) {
            var t = s + 1, u = s - 1;
            // si il y a déjà ce sous-niveau
            if (Read[Id[s]]) {
                // ajout du volume concerné
                Read[Id[s]]["size"] += 1 * data[d].nb;
                // ajout du sous-niveau si il y en a un
                if (s < Id.length - 1) {
                    // vérifie que l'objet n'est pas dedans
                    if (Read[Id[s]]["imports"].indexOf(Id[t]) === -1) Read[Id[s]]["imports"].push(Id[t]);
                }
                if (s > 0) {
                    // vérifie que l'objet n'est pas dedans
                    if (Read[Id[s]]["imports"].indexOf(Id[u]) === -1) Read[Id[s]]["imports"].push(Id[u]);
                }
            } else {
                // création du sous-niveau
                if (s < Id.length - 1) Read[Id[s]] = {
                    "size": 1 * data[d].nb,
                    "imports": [Id[t]]
                }
                else {
                    if (s > 0) Read[Id[s]] = {
                        "size": 1 * data[d].nb,
                        "imports": [Id[u]]
                    }
                    else Read[Id[s]] = {
                    "size": 1 * data[d].nb,
                    "imports": []}
                };
            }
        }
    }
    // console.log(Read);

    // mise en forme de la donnée
    var imports = [];
    for (var r in Read) {
        var line = {
            "name": r,
            "size": Read[r].size,
            "imports": Read[r].imports
        };
        imports.push(line);
    }

    /*d3.json("./data/data.json", function(error, data) {
        if (error) throw error;

        /* traitement des données */
    /*    var result = [];
        for (var d in data) {
            var DS = data[d].domain.split(".");
            for (var mot in DS) {
                if (result[DS[mot]]) result[DS[mot]]["nb"] += data[d].nb;
                else result[DS[mot]] = {
                    "nb": data[d].nb
                };
                for (var mot2 in DS) {
                    if (DS[mot2] !== DS[mot]) {
                        if (result[DS[mot]][DS[mot2]]) result[DS[mot]][DS[mot2]] += data[d].nb;
                        else result[DS[mot]]["" + DS[mot2]] = data[d].nb;
                    }
                }
            }
        }
        /* conversion en json */
    /*    var imports = [];
        for (var mot in result) {
            for (var mot2 in result) {
                if (mot !== mot2) {
                    //console.log(result[mot][mot2]);
                    if (result[mot][mot2]) {
                        if (result[mot2][mot] === "done") {} else {
                            var line = {};
                            line["name"] = mot;
                            line["imports"] = [mot2];
                            line["size"] = result[mot][mot2];
                            imports.push(line);
                            result[mot][mot2] = "done";
                        }
                    }
                }
            }
        }
        // création d'un csv compatible avec radial tidy tree
        // https://bl.ocks.org/mbostock/4063550
        /*
        var html = "<h2>Un csv pour radial tidy tree</h2>id,value<br/>";
        var Groupe = [];
        for (var d in data) {
            var DS = data[d].domain.split(".");
            var gr = "";
            if(DS[0] == "ac") {
                if(Groupe["fr"]) Groupe["fr"] += data[d].nb;
                else Groupe["fr"] = data[d].nb;
                if(Groupe["fr.ac"]) Groupe["fr.ac"] += data[d].nb;
                else Groupe["fr.ac"] = data[d].nb;
                if(Groupe["fr.ac."+DS[1]]) Groupe["fr.ac."+DS[1]] += data[d].nb;
                else Groupe["fr.ac."+DS[1]] = data[d].nb;
            }
            else {
                for (var desc = DS.length - 1; desc >= 0; desc--) {
                gr += DS[desc];
                if(Groupe[gr]) Groupe[gr] += data[d].nb;
                else Groupe[gr] = data[d].nb;
                if (desc !== 0) gr += ".";
                }
            }
        }
        for (var gr in Groupe) {
            html += gr + "," + Groupe[gr] + "<br/>";
        }
        // rendu des mots en quantités par phrases
        // pour utiliser là : https://www.jasondavies.com/wordtree
        /* var html = "<h2>Quantités par mot clés</h2>";
        for (var d in data) {
            var DS = data[d].domain.split(".");
            var phrase = "";
            for (var desc = DS.length - 1; desc >= 0; desc--) {
                phrase += DS[desc];
                if (desc !== 0) phrase += " ";
            }
            phrase += ". ";
            for (var count = 0; count < data[d].nb; count++) {
                html += phrase;
            }
        } */
    /*
    // rendu des laisons
        html += "<h2>Laisons entre mot clés</h2><table>"
    for (var mot in result) {
        for (var mot2 in result) {
            if (mot !== mot2) {
                //console.log(result[mot][mot2]);
                if (result[mot][mot2]) {
                    if (result[mot2][mot] === "done") {}
                    else {
                        html += "<tr><td>" + mot + "</td><td>" + mot2 + "</td><td>" + result[mot][mot2] + "</td></tr>";
                        result[mot][mot2] = "done";
                    }
                }
            }
        }
    }
    html += "</table>";*/
    /*document.getElementById("resultat").innerHTML = html;*/

    //console.log(imports);
    var indexByName = d3.map(),
        nameByIndex = d3.map(),
        matrix = [],
        n = 0;

    // Returns the Flare package name for the given class name.
    function name(name) {
        return name;
    }

    // Compute a unique index for each package name.
    imports.forEach(function(d) {
        if (!indexByName.has(d = name(d.name))) {
            nameByIndex.set(n, d);
            indexByName.set(d, n++);
        }
    });

    // Construct a square matrix counting package imports.
    imports.forEach(function(d) {
        var source = indexByName.get(name(d.name)),
            row = matrix[source];
        if (!row) {
            row = matrix[source] = [];
            for (var i = -1; ++i < n;) row[i] = 0;
        }
        d.imports.forEach(function(d) {
            row[indexByName.get(name(d))]++;
        });
    });

    chord.matrix(matrix);

    var g = svg.selectAll(".group")
        .data(chord.groups)
        .enter().append("g")
        .attr("class", "group");

    g.append("path")
        .style("fill", function(d) {
            return fill(d.index);
        })
        .style("stroke", function(d) {
            return fill(d.index);
        })
        .attr("d", arc);

    g.append("text")
        .each(function(d) {
            d.angle = (d.startAngle + d.endAngle) / 2;
        })
        .attr("dy", ".35em")
        .attr("transform", function(d) {
            return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")" +
                "translate(" + (innerRadius + 26) + ")" +
                (d.angle > Math.PI ? "rotate(180)" : "");
        })
        .style("text-anchor", function(d) {
            return d.angle > Math.PI ? "end" : null;
        })
        .text(function(d) {
            return nameByIndex.get(d.index);
        });

    svg.selectAll(".chord")
        .data(chord.chords)
        .enter().append("path")
        .attr("class", "chord")
        .style("stroke", function(d) {
            return d3.rgb(fill(d.source.index)).darker();
        })
        .style("fill", function(d) {
            return fill(d.source.index);
        })
        .attr("d", d3.svg.chord().radius(innerRadius));

}
            </script>
        </div>
    </div>

    <script>
        var page = window.location.hostname;
        if (navigator.doNotTrack != 1) {
            (function(i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r;
                i[r] = i[r] || function() {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date();
                a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0];
                a.async = 1;
                a.src = g;
                m.parentNode.insertBefore(a, m)
            })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

            ga('set', 'page', page);
            ga('set', 'title', document.title);
            ga('create', 'UA-109815-12', page);
            ga('send', 'pageview');
        }
    </script>

</body>

</html>
